<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Recipe - Fergi's Recipe Collection</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #2c3e50;
            --secondary-color: #e74c3c;
            --accent-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --background: #ecf0f1;
            --card-background: #ffffff;
            --text-color: #2c3e50;
            --text-muted: #7f8c8d;
            --border-color: #bdc3c7;
            --shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--background);
            color: var(--text-color);
            line-height: 1.6;
        }

        header {
            background: linear-gradient(135deg, var(--primary-color), #34495e);
            color: white;
            padding: 2rem;
            box-shadow: var(--shadow);
            text-align: center;
        }

        header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        header p {
            opacity: 0.9;
        }

        .back-button {
            position: absolute;
            top: 2rem;
            left: 2rem;
            padding: 0.7rem 1.5rem;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            text-decoration: none;
            display: inline-block;
        }

        .back-button:hover {
            background: rgba(255,255,255,0.3);
        }

        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .progress-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2rem;
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: var(--shadow);
        }

        .progress-step {
            flex: 1;
            text-align: center;
            position: relative;
            padding: 1rem;
        }

        .progress-step:not(:last-child)::after {
            content: '‚Üí';
            position: absolute;
            right: -1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--border-color);
            font-size: 1.5rem;
        }

        .progress-step.active {
            color: var(--accent-color);
            font-weight: bold;
        }

        .progress-step.completed {
            color: var(--success-color);
        }

        .step {
            display: none;
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }

        .step.active {
            display: block;
        }

        .step h2 {
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 3px solid var(--accent-color);
        }

        .import-options {
            display: flex;
            gap: 2rem;
            margin: 2rem 0;
            justify-content: center;
        }

        .option-btn {
            flex: 1;
            max-width: 300px;
            padding: 3rem 2rem;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: 3px solid var(--border-color);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        .option-btn:hover {
            transform: translateY(-5px);
            border-color: var(--accent-color);
            box-shadow: var(--shadow);
        }

        .option-btn.selected {
            background: linear-gradient(135deg, var(--accent-color), #2980b9);
            color: white;
            border-color: var(--accent-color);
        }

        textarea {
            width: 100%;
            min-height: 300px;
            padding: 1rem;
            border: 2px solid var(--border-color);
            border-radius: 5px;
            font-family: inherit;
            font-size: 1rem;
            resize: vertical;
        }

        textarea:focus, input:focus, select:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 0.7rem;
            border: 2px solid var(--border-color);
            border-radius: 5px;
            font-size: 1rem;
        }

        label {
            display: block;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-color);
        }

        .help-text {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .btn {
            padding: 0.9rem 2rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s;
        }

        .btn-primary {
            background: var(--accent-color);
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .btn-secondary {
            background: var(--text-muted);
            color: white;
        }

        .btn-secondary:hover {
            background: #6c7a89;
        }

        .btn-success {
            background: var(--success-color);
            color: white;
            font-size: 1.2rem;
            padding: 1.2rem 3rem;
        }

        .btn-success:hover {
            background: #229954;
            transform: scale(1.05);
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            justify-content: space-between;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 2px solid var(--border-color);
        }

        .processing {
            text-align: center;
            padding: 3rem;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--accent-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        .two-panel-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-top: 2rem;
        }

        .preview-panel {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 10px;
            border: 2px solid var(--border-color);
        }

        .preview-panel h3 {
            margin-bottom: 1rem;
            color: var(--primary-color);
        }

        .recipe-preview {
            background: white;
            padding: 1.5rem;
            border-radius: 5px;
            box-shadow: var(--shadow);
        }

        .recipe-preview h4 {
            color: var(--primary-color);
            margin: 1rem 0 0.5rem 0;
        }

        .recipe-preview ul,
        .recipe-preview ol {
            padding-left: 1.5rem;
        }

        .recipe-preview li {
            margin-bottom: 0.5rem;
        }

        .edit-panel {
            max-height: 80vh;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .or-divider {
            text-align: center;
            font-size: 1.2rem;
            color: var(--text-muted);
            padding: 0 1rem;
        }

        #newContributorField {
            margin-top: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 5px;
            border: 2px dashed var(--border-color);
        }
    </style>
</head>
<body>
    <header>
        <a href="index.html" class="back-button">‚Üê Back to Recipes</a>
        <h1>Add New Recipe</h1>
        <p>Import and format recipes to Ferguson family standards</p>
    </header>

    <div class="container">
        <!-- Progress Bar -->
        <div class="progress-bar">
            <div class="progress-step active" id="progressStep1">
                <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">1Ô∏è‚É£</div>
                <div>Import</div>
            </div>
            <div class="progress-step" id="progressStep2">
                <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">2Ô∏è‚É£</div>
                <div>Contributor</div>
            </div>
            <div class="progress-step" id="progressStep3">
                <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">3Ô∏è‚É£</div>
                <div>Format</div>
            </div>
            <div class="progress-step" id="progressStep4">
                <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">4Ô∏è‚É£</div>
                <div>Review & Save</div>
            </div>
        </div>

        <!-- Step 1: Import Method -->
        <div id="step1" class="step active">
            <h2>Step 1: Import Recipe</h2>

            <div class="import-options">
                <button class="option-btn" id="uploadFileBtn" onclick="app.selectFileUpload()">
                    <span style="font-size: 3rem;">üìé</span>
                    <span>Upload File</span>
                    <small style="font-size: 0.9rem; opacity: 0.8;">PDF, Word, Images, Text</small>
                </button>
                <span class="or-divider">or</span>
                <button class="option-btn" id="pasteTextBtn" onclick="app.selectPasteText()">
                    <span style="font-size: 3rem;">üìã</span>
                    <span>Paste Text</span>
                    <small style="font-size: 0.9rem; opacity: 0.8;">Copy & paste recipe text</small>
                </button>
            </div>

            <input type="file" id="fileInput" accept=".pdf,.doc,.docx,.pages,.jpg,.jpeg,.png,.txt" style="display:none;" onchange="app.handleFileSelect(event)">

            <div id="pasteArea" class="hidden">
                <textarea id="pasteTextarea" placeholder="Paste recipe text here...

Example:
Chocolate Chip Cookies

Ingredients:
- 2 cups all-purpose flour
- 1 cup granulated sugar
- 1/2 cup butter, softened
- 2 eggs
- 1 tsp vanilla extract
- 1/2 tsp baking soda
- 1 cup chocolate chips

Instructions:
1. Preheat oven to 350¬∞F
2. Mix flour, sugar, and butter until creamy
3. Add eggs and vanilla, beat well
4. Stir in baking soda and chocolate chips
5. Drop by spoonfuls onto baking sheet
6. Bake 10-12 minutes until golden brown
"></textarea>
                <button class="btn btn-primary" style="margin-top: 1rem;" onclick="app.proceedToStep2()">Continue ‚Üí</button>
            </div>

            <div id="fileUploadStatus" class="hidden">
                <p style="color: var(--success-color); font-weight: bold; margin-top: 1rem;">
                    ‚úì File selected: <span id="fileName"></span>
                </p>
                <button class="btn btn-primary" style="margin-top: 1rem;" onclick="app.extractFileContents()">Extract Text & Continue ‚Üí</button>
            </div>

            <p class="help-text">Accepted formats: PDF, Word, Pages, Images (JPG/PNG), Plain Text</p>
            <p class="help-text">Max file size: 10MB. Image processing may take 30-60 seconds.</p>
        </div>

        <!-- Step 2: Contributor Selection -->
        <div id="step2" class="step">
            <h2>Step 2: Select Contributor</h2>

            <label for="contributorSelect">Who is contributing this recipe?</label>
            <select id="contributorSelect" onchange="app.handleContributorSelect()">
                <option value="">-- Select Contributor --</option>
                <!-- Populated by JavaScript -->
                <option value="__new__">+ Add New Contributor</option>
            </select>

            <div id="newContributorField" class="hidden">
                <label for="newContributorName">New Contributor Name:</label>
                <input type="text" id="newContributorName" placeholder="Enter name" onkeypress="app.handleContributorEnter(event)">
                <button class="btn btn-success" style="margin-top: 1rem;" onclick="app.saveNewContributor()">Add & Continue</button>
            </div>

            <p class="help-text">Select from the list or add a new contributor. Anyone can add contributors.</p>

            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="app.goToStep(1)">‚Üê Back</button>
                <button class="btn btn-primary" id="continueToFormat" disabled onclick="app.goToStep(3)">Continue to Format ‚Üí</button>
            </div>
        </div>

        <!-- Step 3: Format with AI -->
        <div id="step3" class="step">
            <h2>Step 3: Format Recipe</h2>

            <p style="margin-bottom: 2rem;">Claude will analyze and reformat your recipe to Ferguson family standards:</p>

            <ul style="margin-left: 2rem; margin-bottom: 2rem; line-height: 2;">
                <li>Clean ingredients list with quantities for shopping reference</li>
                <li>Step-by-step instructions with embedded quantities</li>
                <li>Infer prep time, cook time, and servings if not provided</li>
                <li>Add relevant tags for searchability</li>
                <li>Classify cuisine type and meal type</li>
            </ul>

            <div style="text-align: center;">
                <button class="btn btn-success" onclick="app.formatWithAI()">
                    ‚ú® Format Recipe with AI
                </button>
            </div>

            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="app.goToStep(2)">‚Üê Back</button>
            </div>
        </div>

        <!-- Processing Indicator -->
        <div id="processingIndicator" class="step processing hidden">
            <div class="spinner"></div>
            <h3 id="processingMessage">‚öôÔ∏è Formatting recipe to Ferguson standard...</h3>
            <p class="help-text">This may take 10-30 seconds</p>
        </div>

        <!-- Step 4: Review & Edit -->
        <div id="step4" class="step">
            <h2>Step 4: Review & Edit</h2>

            <div class="two-panel-layout">
                <!-- Left Panel: Preview -->
                <div class="preview-panel">
                    <h3>Preview</h3>
                    <div id="recipePreview" class="recipe-preview">
                        <!-- Rendered recipe card -->
                    </div>
                </div>

                <!-- Right Panel: Edit Form -->
                <div class="edit-panel">
                    <h3>Edit Details</h3>
                    <form id="recipeEditForm">
                        <div class="form-group">
                            <label>Title: *</label>
                            <input type="text" id="title" name="title" required oninput="app.updatePreview()">
                        </div>

                        <div class="form-group">
                            <label>Description:</label>
                            <textarea id="description" name="description" rows="3" oninput="app.updatePreview()"></textarea>
                        </div>

                        <div class="form-group">
                            <label>Cuisine:</label>
                            <select id="cuisine_type" name="cuisine_type" onchange="app.updatePreview()">
                                <option value="American">American</option>
                                <option value="Italian">Italian</option>
                                <option value="Mexican">Mexican</option>
                                <option value="Asian">Asian</option>
                                <option value="French">French</option>
                                <option value="Mediterranean">Mediterranean</option>
                                <option value="Indian">Indian</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Meal Type:</label>
                            <select id="meal_type" name="meal_type" onchange="app.updatePreview()">
                                <option value="breakfast">Breakfast</option>
                                <option value="lunch">Lunch</option>
                                <option value="dinner">Dinner</option>
                                <option value="dessert">Dessert</option>
                                <option value="snack">Snack</option>
                                <option value="appetizer">Appetizer</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Prep Time (minutes):</label>
                            <input type="number" id="prep_time_minutes" name="prep_time_minutes" oninput="app.updatePreview()">
                        </div>

                        <div class="form-group">
                            <label>Cook Time (minutes):</label>
                            <input type="number" id="cook_time_minutes" name="cook_time_minutes" oninput="app.updatePreview()">
                        </div>

                        <div class="form-group">
                            <label>Servings:</label>
                            <input type="text" id="servings" name="servings" placeholder="e.g., 4-6 servings" oninput="app.updatePreview()">
                        </div>

                        <div class="form-group">
                            <label>Ingredients (one per line): *</label>
                            <textarea id="ingredients" name="ingredients" rows="12" required
                                placeholder="2 cups all-purpose flour
1 cup granulated sugar
1/2 cup butter, softened
2 eggs, beaten
1 tsp vanilla extract" oninput="app.updatePreview()"></textarea>
                            <p class="help-text">Include quantities for shopping reference</p>
                        </div>

                        <div class="form-group">
                            <label>Instructions (one step per line): *</label>
                            <textarea id="instructions" name="instructions" rows="15" required
                                placeholder="Preheat oven to 350¬∞F.
In a large bowl, mix 2 cups flour and 1 cup sugar.
Add 1/2 cup softened butter and beat until creamy.
Mix in 2 beaten eggs and 1 tsp vanilla extract.
Bake for 25-30 minutes until golden brown." oninput="app.updatePreview()"></textarea>
                            <p class="help-text">Include quantities in each step for cooking</p>
                        </div>

                        <div class="form-group">
                            <label>Tags (comma-separated):</label>
                            <input type="text" id="tags" name="tags" placeholder="quick, easy, family-favorite" oninput="app.updatePreview()">
                        </div>

                        <div class="form-group">
                            <label>Notes (optional):</label>
                            <textarea id="notes" name="notes" rows="3" oninput="app.updatePreview()"></textarea>
                        </div>
                    </form>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="app.reformatWithAI()">‚Üê Re-format with AI</button>
                <button class="btn btn-success" onclick="app.saveRecipe()">Save Recipe ‚Üí</button>
            </div>
        </div>
    </div>

    <script>
        const app = {
            apiUrl: '/api',
            currentStep: 1,
            rawRecipeText: '',
            selectedFile: null,
            selectedContributor: '',
            formattedRecipe: null,
            contributors: [],

            async init() {
                await this.loadContributors();
            },

            async loadContributors() {
                try {
                    const response = await fetch(`${this.apiUrl}/manage-contributors`);
                    const data = await response.json();
                    if (data.success) {
                        this.contributors = data.contributors;
                        this.populateContributorDropdown();
                    }
                } catch (error) {
                    console.error('Error loading contributors:', error);
                }
            },

            populateContributorDropdown() {
                const select = document.getElementById('contributorSelect');
                const newOption = select.querySelector('option[value="__new__"]');

                // Clear existing options except first and last
                select.innerHTML = '<option value="">-- Select Contributor --</option>';

                // Add contributors
                this.contributors.forEach(contributor => {
                    const option = document.createElement('option');
                    option.value = contributor;
                    option.textContent = contributor;
                    select.appendChild(option);
                });

                // Re-add "Add New" option
                select.appendChild(newOption.cloneNode(true));
            },

            selectFileUpload() {
                document.getElementById('uploadFileBtn').classList.add('selected');
                document.getElementById('pasteTextBtn').classList.remove('selected');
                document.getElementById('pasteArea').classList.add('hidden');
                document.getElementById('fileInput').click();
            },

            selectPasteText() {
                document.getElementById('pasteTextBtn').classList.add('selected');
                document.getElementById('uploadFileBtn').classList.remove('selected');
                document.getElementById('pasteArea').classList.remove('hidden');
                document.getElementById('pasteTextarea').focus();
            },

            handleFileSelect(event) {
                const file = event.target.files[0];
                if (!file) return;

                if (file.size > 10 * 1024 * 1024) {
                    alert('File too large. Maximum size is 10MB.');
                    return;
                }

                this.selectedFile = file;
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('fileUploadStatus').classList.remove('hidden');
            },

            async extractFileContents() {
                this.showProcessing('Extracting text from file...');

                try {
                    const formData = new FormData();
                    formData.append('file', this.selectedFile);

                    const response = await fetch(`${this.apiUrl}/extract-file`, {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();

                    if (data.success) {
                        this.rawRecipeText = data.text;
                        this.hideProcessing();
                        this.goToStep(2);
                    } else {
                        throw new Error(data.error || 'Failed to extract text');
                    }
                } catch (error) {
                    this.hideProcessing();
                    alert('Error extracting text from file: ' + error.message);
                    console.error('Error:', error);
                }
            },

            proceedToStep2() {
                const text = document.getElementById('pasteTextarea').value.trim();
                if (text.length < 50) {
                    alert('Please enter more text. A recipe should have at least 50 characters.');
                    return;
                }
                this.rawRecipeText = text;
                this.goToStep(2);
            },

            handleContributorSelect() {
                const select = document.getElementById('contributorSelect');
                const value = select.value;

                if (value === '__new__') {
                    document.getElementById('newContributorField').classList.remove('hidden');
                    document.getElementById('newContributorName').focus();
                    document.getElementById('continueToFormat').disabled = true;
                } else if (value) {
                    document.getElementById('newContributorField').classList.add('hidden');
                    this.selectedContributor = value;
                    document.getElementById('continueToFormat').disabled = false;
                } else {
                    document.getElementById('newContributorField').classList.add('hidden');
                    document.getElementById('continueToFormat').disabled = true;
                }
            },

            handleContributorEnter(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    this.saveNewContributor();
                }
            },

            async saveNewContributor() {
                const input = document.getElementById('newContributorName');
                const newName = input.value.trim();

                if (!newName) {
                    alert('Please enter a contributor name');
                    return;
                }

                try {
                    const response = await fetch(`${this.apiUrl}/manage-contributors`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contributor: newName })
                    });

                    const data = await response.json();

                    if (data.success) {
                        // Refresh dropdown
                        await this.loadContributors();

                        // Select the new contributor
                        document.getElementById('contributorSelect').value = newName;
                        this.selectedContributor = newName;

                        // Hide input field
                        document.getElementById('newContributorField').classList.add('hidden');

                        // Enable continue button
                        document.getElementById('continueToFormat').disabled = false;

                        alert(`Contributor "${newName}" added successfully!`);
                    } else {
                        alert(data.error || 'Failed to add contributor');
                    }
                } catch (error) {
                    alert('Error adding contributor: ' + error.message);
                    console.error('Error:', error);
                }
            },

            async formatWithAI() {
                this.showProcessing('Formatting recipe to Ferguson standard...');

                try {
                    const response = await fetch(`${this.apiUrl}/format-recipe`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            text: this.rawRecipeText,
                            contributor: this.selectedContributor,
                            original_filename: this.selectedFile?.name
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        this.formattedRecipe = data.recipe;
                        this.populateEditForm();
                        this.updatePreview();
                        this.hideProcessing();
                        this.goToStep(4);
                    } else {
                        throw new Error(data.error || 'Failed to format recipe');
                    }
                } catch (error) {
                    this.hideProcessing();
                    alert('Error formatting recipe: ' + error.message);
                    console.error('Error:', error);
                }
            },

            async reformatWithAI() {
                if (!confirm('This will re-format the recipe with AI and overwrite your current edits. Continue?')) {
                    return;
                }

                this.goToStep(3);
                setTimeout(() => this.formatWithAI(), 100);
            },

            populateEditForm() {
                const recipe = this.formattedRecipe;

                document.getElementById('title').value = recipe.title || '';
                document.getElementById('description').value = recipe.description || '';
                document.getElementById('cuisine_type').value = recipe.cuisine || 'American';
                document.getElementById('meal_type').value = recipe.meal_type || 'dinner';
                document.getElementById('prep_time_minutes').value = recipe.prep_time || '';
                document.getElementById('cook_time_minutes').value = recipe.cook_time || '';
                document.getElementById('servings').value = recipe.servings || '';

                // Convert arrays to text
                document.getElementById('ingredients').value = (recipe.ingredients || []).join('\n');
                document.getElementById('instructions').value = (recipe.instructions || []).join('\n');
                document.getElementById('tags').value = (recipe.tags || []).join(', ');
                document.getElementById('notes').value = recipe.notes || '';
            },

            updatePreview() {
                const title = document.getElementById('title').value;
                const description = document.getElementById('description').value;
                const prepTime = document.getElementById('prep_time_minutes').value;
                const cookTime = document.getElementById('cook_time_minutes').value;
                const servings = document.getElementById('servings').value;
                const ingredientsText = document.getElementById('ingredients').value;
                const instructionsText = document.getElementById('instructions').value;

                const ingredients = ingredientsText.split('\n').filter(line => line.trim());
                const instructions = instructionsText.split('\n').filter(line => line.trim());

                let html = `
                    <h2 style="color: var(--primary-color); margin-bottom: 1rem;">${title || 'Recipe Title'}</h2>
                    ${description ? `<p style="margin-bottom: 1rem; color: var(--text-muted);">${description}</p>` : ''}

                    <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem; font-size: 0.9rem; color: var(--text-muted);">
                        ${prepTime ? `<div>‚è±Ô∏è Prep: ${prepTime} min</div>` : ''}
                        ${cookTime ? `<div>üî• Cook: ${cookTime} min</div>` : ''}
                        ${servings ? `<div>üçΩÔ∏è Servings: ${servings}</div>` : ''}
                    </div>

                    ${ingredients.length > 0 ? `
                        <h4>Ingredients:</h4>
                        <ul>
                            ${ingredients.map(ing => `<li>${ing}</li>`).join('')}
                        </ul>
                    ` : ''}

                    ${instructions.length > 0 ? `
                        <h4>Instructions:</h4>
                        <ol>
                            ${instructions.map(inst => `<li>${inst}</li>`).join('')}
                        </ol>
                    ` : ''}
                `;

                document.getElementById('recipePreview').innerHTML = html;
            },

            async saveRecipe() {
                const title = document.getElementById('title').value.trim();
                if (!title) {
                    alert('Please enter a recipe title');
                    return;
                }

                const ingredientsText = document.getElementById('ingredients').value.trim();
                const instructionsText = document.getElementById('instructions').value.trim();

                if (!ingredientsText || !instructionsText) {
                    alert('Please provide both ingredients and instructions');
                    return;
                }

                const ingredients = ingredientsText.split('\n').filter(line => line.trim());
                const instructions = instructionsText.split('\n').filter(line => line.trim());
                const tags = document.getElementById('tags').value.split(',').map(tag => tag.trim()).filter(t => t);

                const recipe = {
                    title: title,
                    description: document.getElementById('description').value.trim(),
                    cuisine_type: document.getElementById('cuisine_type').value,
                    meal_type: document.getElementById('meal_type').value,
                    prep_time_minutes: parseInt(document.getElementById('prep_time_minutes').value) || null,
                    cook_time_minutes: parseInt(document.getElementById('cook_time_minutes').value) || null,
                    total_time_minutes: (parseInt(document.getElementById('prep_time_minutes').value) || 0) + (parseInt(document.getElementById('cook_time_minutes').value) || 0) || null,
                    servings: document.getElementById('servings').value.trim(),
                    ingredients: ingredients.map((ing, index) => ({
                        ingredient_order: index + 1,
                        quantity: '',
                        unit: '',
                        ingredient_name: ing,
                        preparation_notes: ''
                    })),
                    instructions: instructions.map((inst, index) => ({
                        step_number: index + 1,
                        instruction_text: inst
                    })),
                    tags: tags,
                    notes: document.getElementById('notes').value.trim(),
                    contributor: this.selectedContributor,
                    date_added: new Date().toISOString(),
                    import_method: this.selectedFile ? 'file_upload' : 'text_paste',
                    source_attribution: this.selectedFile?.name || 'Manual Entry',
                    favorite: 0,
                    rating: null
                };

                this.showProcessing('Saving recipe...');

                try {
                    const response = await fetch(`${this.apiUrl}/add-recipe`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ recipe })
                    });

                    const data = await response.json();

                    if (data.success) {
                        this.hideProcessing();
                        alert(`Recipe "${title}" saved successfully!`);
                        window.location.href = 'index.html';
                    } else {
                        throw new Error(data.error || 'Failed to save recipe');
                    }
                } catch (error) {
                    this.hideProcessing();
                    alert('Error saving recipe: ' + error.message);
                    console.error('Error:', error);
                }
            },

            goToStep(stepNumber) {
                // Hide all steps
                document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));

                // Update progress bar
                for (let i = 1; i <= 4; i++) {
                    const progressStep = document.getElementById(`progressStep${i}`);
                    progressStep.classList.remove('active', 'completed');
                    if (i < stepNumber) {
                        progressStep.classList.add('completed');
                    } else if (i === stepNumber) {
                        progressStep.classList.add('active');
                    }
                }

                // Show current step
                document.getElementById(`step${stepNumber}`).classList.add('active');
                this.currentStep = stepNumber;

                // Scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });
            },

            showProcessing(message) {
                document.getElementById('processingMessage').textContent = message;
                document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
                document.getElementById('processingIndicator').classList.remove('hidden');
                document.getElementById('processingIndicator').classList.add('active');
            },

            hideProcessing() {
                document.getElementById('processingIndicator').classList.remove('active');
                document.getElementById('processingIndicator').classList.add('hidden');
            }
        };

        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>
</body>
</html>
